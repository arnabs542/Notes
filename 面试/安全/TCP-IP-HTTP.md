> TCP/IP HTTP的面试常见问题

[TOC]

# TCP/IP

## TCP和UDP的区别？分别适用场景？

* UDP 在传送数据之前不需要先建立连接，远地主机在收到 UDP 报文后，不需要给出任何确认。虽然 UDP 不提供可靠交付，但在某些情况下 UDP 确是一种最有效的工作方式（一般用于即时通信），比如： QQ 语音、 QQ 视频 、直播等等
* TCP 提供面向连接的服务。在传送数据之前必须先建立连接，数据传送结束后要释放连接。 TCP 不提供广播或多播服务。由于 TCP 要提供可靠的，面向连接的运输服务（TCP的可靠体现在TCP在传递数据之前，会有三次握手来建立连接，而且在数据传递时，有确认、窗口、重传、拥塞控制机制，在数据传完后，还会断开连接用来节约系统资源），这一难以避免增加了许多开销，如确认，流量控制，计时器以及连接管理等。这不仅使协议数据单元的首部增大很多，还要占用许多处理机资源。TCP 一般用于文件传输、发送和接收邮件、远程登录等场景。



<table>
   <tr>
      <td rowspan="2">类型</td>
      <td colspan="3">特点</td>
      <td colspan="2">性能</td>
      <td rowspan="2">应用场景</td>
      <td rowspan="2">首部字节</td>
   </tr>
   <tr>
      <td>是否面向连接</td>
      <td>传输可靠性</td>
      <td>传输形式</td>
      <td>传输效率</td>
      <td>所需资源</td>
   </tr>
   <tr>
      <td>TCP</td>
      <td>面向连接</td>
      <td>可靠</td>
      <td>字节流</td>
      <td>慢</td>
      <td>多</td>
      <td>要求通信数据可靠(如文件传输,邮件传输)</td>
      <td>20-60</td>
   </tr>
   <tr>
      <td>UDP</td>
      <td>无连接</td>
      <td>不可靠</td>
      <td>数据报字段</td>
      <td>快</td>
      <td>少</td>
      <td>要求通信速度高(如即时语音)</td>
      <td>8字节</td>
   </tr>
</table>





![TCPUDP对比](https://tva1.sinaimg.cn/large/007S8ZIlgy1gi2263eveuj316h0mcqak.jpg)

## TCP三次握手

### 三次握手

* 第一次握手: 客户端发送SYN=1 的数据包到服务端
  * 此时 SYN=1 ACK=0 seq=x
* 第二次握手: 服务端发送SYN=1 ACK=1 的数据包到服务端 
  * 此时ackseq=x+1  seq= y  SYN=1 ACK=1
* 第三次握手: 客户端发送ACK=1 的数据包到服务端
  * 此时SYN=0 ACK=1 ackseq = y+1 



### 为什么需要三次握手

**目的 : **建立可靠的通信信道,确认自己与对方的发送和接收都是正常的.

* 第一次握手: 
  * Client 无确认
  * Server 对方发送正常
* 第二次握手:
  * Client 确认自己发送,接收正常,对方发送,接收正常
  * Server 自己接收正常,对方发送正常
* 第三次握手: 
  * Client 确认自己发送,接收正常,对方发送,接收正常
  * Server 确认自己发送,接收正常,对方发送,接收正常

 

### 为什么要回传SYN,ACK

#### 回传SYN

接收端传回发送端所发送的SYN是为了告诉发送端,我接受到信息确实就是你发送的信号

#### 回传ACK

双方通信无误必须是两者互相发送信息都无误。传了 SYN，证明发送方到接收方的通道没有问题，但是接收方到发送方的通道还需要 ACK 信号来进行验证。





## 四次挥手(断开TCP连接)

* 第一次挥手: 客户端发送一个FIN,用来关闭客户端到服务端的数据传送
  * 此时 FIN=1 seq=u
* 第二次挥手: 服务端收到FIN后,向客户端发送一个ACK,确认序号为收到的序号
  * 此时ACK=1 seq=v ack=u+1
* 第三次挥手: 服务端关闭与客户端的连接,发送一个FIN给客户端
  * 此时FIN=1 ACK=1 seq=w ack=u+1
* 第四次挥手: 客户端发回ACK报文确认,并将确认序号设置为收到序号+1
  * 此时ACK=1 seq=u+1 ack=w+1

### 为什么要四次挥手

任何一方都可以在数据传送结束后发出连接释放通知,待对方确认后进入半关闭状态.

当另一方也没有数据再要发送的时候,则发出连接释放通知,对方确认后就完全关闭了TCP连接



## TCP拥塞控制

有了TCP的窗口控制,能连续发生大量的数据包,可能会因为其他的主机之间的通信导致网络拥堵.

在网络拥堵时,如果突然发送一个较大的数据,极有可能会导致整个网络的瘫痪,TCP为了防止这个现象的出现.

在通信开始的时候会通过以叫做**慢启动**的算法得出数值,对发送的数据量进行控制.

TCP拥塞控制采用的四种算法**慢开始,拥塞避免,快重传,快恢复**.

在网络层也可以使用路由器采用适当的分组丢弃策略(如主动队列管理AQM)



## TCP滑动窗口和回退N帧协议

TCP的传输方式有个缺点: 包的往返时间越长通信性能越差,网络的吞吐量会越差.

为了解决上述的问题,TCP引入了窗口,即使往返时间较长,也能控制网络性能的下降.

用滑动窗口并行处理,确认应答不是以个分段,而是以更大的单位进行确认,转发时间就被缩短了.这个机制的实现使用了大量的缓冲区

* TCP使用滑动窗口实现流量控制的机制
* 滑动窗口(Sliding window) 是一种流量控制技术.早期的网络通信中,通信双方并不会考虑网络的拥挤情况直接发送数据.由于大家不知道网络的拥塞状况,同时发送数据,导致中间节点阻塞掉包,导致谁有发不了数据,所以就有了滑动窗口机制来解决问题
* TCP中采用滑动窗口来进行传输控制,滑动窗口的大小意味着接收方还有多大的缓冲区可以用于接收数据.发送方可以用过滑动窗口的大小来确定应该发送的多少字节的数据.当滑动窗口为0时,发送方一般不能再发送数据报,但有两种情况除外,一种情况是可以发送紧急数据,例如允许用户终止在终端机上运行的进程.另一种情况是发送方可以发送一个1字节的数据包来通知接收方重新声明它希望接收的下一字节及发送方的滑动窗口大小.

## 什么是长连接

* HTTP/1.0中默认使用短连接.
  * 及客户端和服务器每进行一次HTTP操作,就建立一次连接,任务结束就中断连接.当客户端浏览器访问某个HTML或者其他类型的WEB页面中包含有其他的WEB资源(JS文件,图片,CSS文件),每遇到这样的一个WEB资源,浏览器就会重新建立一个HTTP会话
* HTTP/1.1起,默认使用长连接.用以保持连接特性,使用长连接的HTTP协议,会在响应头加入这行代码`Connection:keep-alive`
  * 使用长连接的情况下,当一个网页打开完成后,客户端和服务器之间用于传输HTTP的TCP连接不会关闭,客户端再次访问这个服务器时,会继续使用这一条已经建立的连接,KeepAlive不会永久保持连接,它有一个保持时间,可以再不同的服务器软件中设定这个时间.实现长连接需要客户端和服务端都支持长连接
* HTTP的长连接和短连接,实质上是TCP协议的长连接和短连接