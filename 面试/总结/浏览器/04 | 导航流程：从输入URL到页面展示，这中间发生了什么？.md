## 04 | 导航流程：从输入URL到页面展示，这中间发生了什么？

**在浏览器里，从输入 URL 到页面展示，这中间发生了什么？**
![20200831100137](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831100137.png)
- 首先，浏览器进程接收到用户输入的 URL 请求，浏览器进程便将该 URL 转发给网络进程。
- 然后，在网络进程中发起真正的 URL 请求。
- 接着网络进程接收到了响应头数据，便解析响应头数据，并将数据转发给浏览器进程。
- 浏览器进程接收到网络进程的响应头数据之后，发送“提交导航 (CommitNavigation)”消息到渲染进程；渲染进程接收到“提交导航”的消息之后，便开始准备接收 HTML 数据，接收数据的方式是直接和网络进程建立数据管道；
- 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接受和解析页面数据了”。浏览器进程接收到渲染进程“提交文档”的消息之后，便开始移除之前旧的文档，然后更新浏览器进程中的页面状态。

**从输入 URL 到页面展示**
1. 用户输入：搜索内容，还是请求的 URL。
- 是搜索内容，则使用 浏览器默认的搜索引擎。
- 如果判断输入符合URL的规则，那么就加上协议，合成完整的URL。
- 在替换成新的界面之前，浏览器还会执行beforeunload事件，来保证本网页的表单的提交。
2. URL 请求过程
- 浏览器通过IPC将URL请求发送至网络进程。网络进程接收到URL请求以后，在这里发起真正的URL请求流程。
- 网络进程会查找本地缓存，有则直接返回。如果没有，直接进入网络流程。第一步DNS解析，获取ip地址。如果是HTTPS，还需要建立TLS连接。
- 接着，利用ip地址与服务器建立TCP连接。连接建立以后，浏览器构建请求行、请求头等等信息，并且将Cookie数据加到请求头中，接着向服务器发送构建求情信息。
- 服务器接收到请求信息，生成响应数据，发给网络进程。网络进程响应数据，解析响应头的内容。
**（1）重定向**
网络进程解析响应头，查看**状态码301或302，**代表重定向。网络进程将读取**Location**的重定向地址，再发起新的Http或Https请求。一切又重头开始。
  - 发送Http请求
``` JS
curl -I http://time.geekbang.org/
```
![20200831105625](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831105625.png)

  - 发送https请求
![20200831105927](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831105927.png)
返回200，正常

**（2）响应数据类型处理**
Content告诉浏览器服务器返回的响应数据的类型。
``` JS
curl -I https://time.geekbang.org/
```
![20200831110250](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831110250.png)

curl 来请求极客时间安装包的地址
``` JS
curl -I https://res001.geekbang.org/apps/geektime/android/2.3.1/official/geektime_2.3.1_20190527-2136_offical.apk
```
![20200831110300](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831110300.png)

**3. 准备渲染进程**
![20200831110423](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831110423.png)

*那什么情况下多个页面会同时运行在一个渲染进程中呢？*
  - 同一站点
``` JS
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```
  - 不同站点
![20200831110603](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831110603.png)

**4. 提交文档**
- 当浏览器进程接收到网络进程的响应头数据以后，便向渲染进程发起“提交文档”的消息。
- 渲染进程接到手“提交文档消息后”，会和网络进程建立数据传输“管道”。
- 等文档数据传输完成以后，渲染进程会返回“确认提交”的悉尼给浏览器进程。
- 浏览器收到“确认提交的消息后”，会更新浏览器的界面的状态。包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web页面。

*导航完成*
![20200831111110](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831111110.png)
**5. 渲染阶段**
一旦文档被提交，渲染进程会发送一个消息给浏览器进程。浏览器接收到消息以后会听着标签图标的加载动画。
![20200831111318](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831111318.png)

**总结**、
![20200831100137](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200831100137.png)
1. 浏览器地址栏检测用户输入，是搜索内容则使用默认浏览器搜索。如果不是则加上协议，组合成完整的URL来访问。
2. 浏览器进程通过进程通信（ipc），将URL请求发送给网络进程。
3. 网络进程接收到请求rul后，检查本地是否有该请求的缓存，如果有则直接返回给浏览器进程。
4. 如果没有，网络进程会向web服务区发起http请求。
 - 进程DNS解析，获得服务器ip地址和端口。
 - 利用ip地址和服务器建立tcp连接。
 - 构建请求头的信息。
 - 发送请求头信息。
 - 服务器响应后，网络进程接收响应头和响应信息，并解析响应内容。
5. 网络进程解析响应：
 - 检查状态码，如果是301和302，则需要根据响应信息中的Location字段读取重定向地址(从来来过，做完整的网络请求)。如果是状态码200，则继续请求处理。
 - 200响应处理。检查响应类型，如果是字节流则提供下载，如果是导航流程，不在进行。
6. 准备渲染进程
 - 浏览器进程检查当然url是否和之前打开过的渲染进程根域名是否相同，如果相同，则复用原来的进程。如果不同，则开启新的渲染进程。
 - 渲染进程接受完数据后，向浏览器发送“确认提交”。
 - 浏览器进程接受到确认消息后，更新浏览器界面状态： 安全、地址栏URL、前进后退的历史状态、更新web界面。