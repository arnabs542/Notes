## Chrome架构，打开一个界面，开始四个进程
![20200620200347](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200347.png)
学习浏览器的多进程架构很有必要。Chrome是很有代表性。
        ![20200620200408](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200408.png)
上图展示出，Chrome打开了一个网页，但是出现了四个进程。那么为什么呢？

### 进程和线程
首先来了解下什么是并行处理哈。
#### 什么是并行处理
```
a = 1 + 2;
b = 20 / 2;
c = 12 * 12;
```
上述代码执行结果

第一步：计算A
第二步：计算B
第三步：计算C
第四步：计算最后的结果。

那么在正常情况下，程序是使用单进程来按照顺序来执行这个四个步骤的。但是如果我们使用多线程的化，第一步同时执行前面三行，第二步来执行最后的显示任务。

这样我们不难看出，使用单线程需要四步，使用多线程而需要两步。因此，使用并行处理能大大提升性能。

### 进程VS进程
多线程可以并行处理任务，不过线程可以单独存在，他是由进程来启动和管理的。一个进程就是程序的运行实例。
也就是说，当你启动一个程序的时候，操作系统会为该进程创建一块内存，用来存放代码、运行中代码和一个执行任务的主线程，这个运行环境叫进程。


![20200620200424](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200424.png)
<center>单线程和多线程对比图</center>

线程是依赖进程的，而进程中使用多线程并行处理可以提升运行效率。

1. 进程中的任意一线程执行出错的话，都会导致整个进程崩溃。

```
a = 1 + 2;
b = 20 / 0;
c = 12 * 12;
```
这个时候计算b的时候，分母是0，那么当线程执行的时候，线程会执行出错，导致整个进程崩溃，因此其他的两个执行结果也没有了。

2. 线程和进程之前共享数据。
![20200620200439](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200439.png)
<center>线程和进程数据共享示意图</center>

上图可以看出，线程 1、线程 2、线程 3 分别把执行的结果写入 A、B、C 中，然后线程 2 继续从 A、B、C 中读取数据，用来显示执行结果。

1. 当一个进程关闭，操作系统会回收占用的内存。当一个进程关闭后，操作系统会回收这个进程申请的所有资源。即使会出现任意线程因为操作不当导致内存泄漏，当进程被关闭，这些内存也会被正常回收。这里举个例子：插件很容易导致内存泄漏。

2. 进程之间内容相互隔离。
进程之间运行都是相互隔离，本进程只能访问自己占有的数据。如果向在进程中进行数据通信，那么需要使用进程间通信（IPC）机制。

### 单进程浏览器时代

单进程浏览器是指浏览器的所有功能模块都是运行在同一个进程。

![20200620200457](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200457.png)
<center>单进程浏览器架构示意图</center>

- **问题一：不稳定**

早期的浏览器借助插件来实现视频和游戏的功能，但是插件很容易崩溃。如果一个插件崩溃，那么整个浏览器进程都会崩溃。不仅仅是插件进程，渲染进程也是如此，比如：执行的JavaScript代码可能引起渲染引擎模块的崩溃。

- **问题二：不流畅**

所有的界面渲染模块、JavaScript执行环境都是运行在同一个线程中，这就意味着同一时刻只能有一个模块可以执行。

比如：下面这个函数：
```js
function imp(){
    while (1) {
		console.log("imp");
	}
}
imp();
```

上述代码，是一个无限循环，这个时候他就会长期独占整个线程，从而导致其他运行在这个线程中的模块就没有机会被执行。因而浏览器就会失去响应或者变得卡顿。

- **问题三：不安全**

因为浏览器可以使用插件，那么就会有恶意插件的植入，那么会导致浏览器的用户登陆信息或者其他的信息被盗取。

### 多进程浏览器
#### 早期的进程架构

![20200620200509](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200509.png)
<center>早期 Chrome 进程架构图</center>

根据上图我们可以很清楚的看出，插件进程和渲染进程被单独处理，每个进程都是相互隔离的。即使插件或者渲染进程出现崩溃，那也只会导致这个模块崩溃，不会导致整个浏览器的界面的崩溃。

#### 解决问题

- **解决问题一：不稳定**

进程之间相互隔离，出现崩溃也只是单个模块的崩溃，不会影响整个浏览器的运行。

- **解决问题二：不流畅**

JavaScript是运行在渲染进程中，即使JavaScript代码阻塞了渲染进程，也只是影响到当前的渲染界面，不会影响到浏览器和其他界面。

对于内存泄漏的结局，当你关闭一个页面的时候，整个渲染引擎也都不会被关闭，系统回收所占用的内存。

- **解决问题三：不安全**

采用安全沙箱，沙箱程序可以运行，但是不能在你的硬盘写入数据，不也可以读取关键位置的数据，因此就恶意的插件就没有了执行的权限，也不会危害系统。

### 目前的多系统架构

![20200620200520](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200520.png)
<center>最新的 Chrome 进程架构图</center>

- **浏览器进程**。主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- **渲染进程**。核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，Chrome会给每个Tab标签创建一个渲染进程。安全方面，使用沙箱。
- **GPU 进程**。GPU为了高效的实现3D CSS的效果，而后，Chrome的UI界面也都是采用GPU来绘制。
- **网络进程**。主要负责页面的网络资源的加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。
- **插件进程**。因为插件经常崩溃，所以需要把插件进程进行隔离，来保证执行插件的时候不会影响到页面。

#### 题目解答
这个时候我们应该理解了为什么打开一个页面会有四个进程。
分别是：1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个。

#### 浏览器存在的问题
- **更高资源占用**

因为每个进程之间都会有公共基础结构副本，这个就意味着浏览器会消耗更多的内存资源。

- **更复杂体系结构**
浏览器各个模块之间耦合性高、拓展性差。

### 未来面向服务的架构

2016年，Chrome提出了“面向服务的架构”（Services Oriented Architecture，简称SOA）的思想设计了新的 Chrome 架构。Chrome 整体架构会朝向现代操作系统所采用的“面向服务的架构” 方向发展，原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，更好实现 Chrome 简单、稳定、高速、安全的目标。


![20200620200539](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200539.png)
<center>Chrome“面向服务的架构”进程模型图</center>


**目前谷歌正在架构过度阶段**

谷歌提供灵活的弹性架构，在强大的设备上会以多进程地方方式运行基础服务，但是资源不够的设备商，Chrome将会把多个服务都整合到同一个进程中，从而达到节省内存占用。

![20200620200546](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/pictures/20200620200546.png)

<center>在资源不足的设备上，将服务合并到浏览器进程中</center>

