# 14 | 编译器和解释器：V8是如何执行一段JavaScript代码的？
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906288728817.jpg)

今天我们来介绍下浏览器引擎V8，在浏览器中JavaScript代码是怎样被执行的。想要深入的了解V8工作原理，我们要详细了解下**编译器（Compiler）、解释器（Interpreter）、抽象语法树（AST）、字节码（Bytecode）、即时编译器（JIT）等概念**

## 编译器和解释器
之所以有编译器和解释器，是因为机器不可直接理解我们的代码，在执行期间需要将代码“翻译”为机器可以看懂的。所以我们常说**编译型语言和解释型语言**。

**编译型语言** —> **编译器(机器保留二进制文件)** -> **直接运行二进制文件** 比如 C/C++、GO 等都是编译型语言。

**解释型语言编写的程序** -> **解释器对程序进行动态解释和执行** 比如 Python、JavaScript 等都属于解释型语言。

那编译器和解释器是如何“翻译”代码的呢？具体流程你可以参考下图：
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906296520710.jpg)
<center>编译器和解释器“翻译”代码</center>

从图中你可以看出这二者的执行流程，大致可阐述为如下：
1. 在编译型语言的编译过程中，编译器首先会依次对源代码进行词法分析、语法分析，生成抽象语法树（AST），然后是优化代码，最后再生成处理器能够理解的机器码。如果编译成功，将会生成一个可执行的文件。但如果编译过程发生了语法或者其他的错误，那么编译器就会抛出异常，最后的二进制文件也不会生成成功。
2. 在解释型语言的解释过程中，同样解释器也会对源代码进行词法分析、语法分析，并生成抽象语法树（AST），不过它会再基于抽象语法树生成字节码，最后再根据字节码来执行程序、输出结果。

## V8 是如何执行一段 JavaScript 代码的
我们就重点分析下 V8 是如何执行一段 JavaScript 代码的。你可以先来“一览全局”，参考下图：
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906299368308.jpg)
<center>V8 执行一段代码流程图</center>
从图中可以清楚地看到，V8 在执行过程中既有**解释器 Ignition**，又有**编译器 TurboFan**，那么它们是如何配合去执行一段 JavaScript 代码的呢? 下面我们就按照上图来一一分解其执行流程。

<font color=red>1. 生成抽象语法树（AST）和执行上下文</font>

将源代码转换为抽象语法树，并生成执行上下文。高级语言会让编译器和解释器难以理解，所以你用那种语言在编译过程中都会生成一个AST。

我们通过一段代码来了解什么是AST：
```JavaScript
var myName = " 极客时间 "
function foo(){
  return 23;
}
myName = "geektime"
foo()
```
  
这段代码经过javascript-ast站点处理后，生成的 AST 结构如下：
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906311427566.jpg)
<center>抽象语法树（AST）结构</center>

**编译器或者解释器后续的工作都需要依赖于 AST，而不是源代码。**


AST 是非常重要的一种数据结构，在很多项目中有着广泛的应用。其中最著名的一个项目是 Babel。**Babel** 是一个被广泛使用的代码转码器，可以将 ES6 代码转为 ES5 代码，这意味着你可以现在就用 ES6 编写程序，而不用担心现有环境是否支持 ES6。Babel 的工作原理就是先将 ES6 源码转换为 AST，然后再将 ES6 语法的 AST 转换为 ES5 语法的 AST，最后利用 ES5 的 AST 生成 JavaScript 源代码。

除了 Babel 外，还有 **ESLint**也使用 AST。ESLint 是一个用来检查 JavaScript 编写规范的插件，其检测流程也是需要将源码转换为 AST，然后再利用 AST 来检查代码规范化的问题。

**那么现在我们来了解一下AST的生成的两个阶段**

1.**第一阶段是分词（tokenize），又称为词法分析**，其作用是将一行行的源码拆解成一个个 token。所谓token，指的是语法上不可能再分的、最小的单个字符或字符串。你可以参考下图来更好地理解什么 token。
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906319522832.jpg)
<center>分解 token 示意图</center>
从图中可以看出，通过var myName = “极客时间”简单地定义了一个变量，其中关键字“var”、标识符“myName” 、赋值运算符“=”、字符串“极客时间”四个都是 token，而且它们代表的属性还不一样。
***
**第二阶段是解析（parse），又称为语法分析**，<font color=red>其作用是将上一步生成的 token 数据，根据语法规则转为 AST</font>。如果源码符合语法规则，这一步就会顺利完成。但如果源码存在语法错误，这一步就会终止，并抛出一个“语法错误”。
***
**这就是 AST 的生成过程，先分词，再解析。**
***
<font color=red>2. 生成字节码</font>
有了 AST 和执行上下文后，那接下来的第二步，解释器 Ignition 就登场了，它会根据 AST 生成字节码，并解释执行字节码。

其实一开始 V8 并没有字节码，而是直接将 AST 转换为机器码，由于执行机器码的效率是非常高效的，所以这种方式在发布后的一段时间内运行效果是非常好的。但是随着 Chrome 在手机上的广泛普及，特别是运行在 512M 内存的手机上，内存占用问题也暴露出来了，因为 V8 需要消耗大量的内存来存放转换后的机器码。为了解决内存占用问题，V8 团队大幅重构了引擎架构，引入字节码，并且抛弃了之前的编译器，最终花了将进四年的时间，实现了现在的这套架构。

那什么是字节码呢？为什么引入字节码就能解决内存占用问题呢？

**字节码就是介于 AST 和机器码之间的一种代码。但是与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码后才能执行。**

理解了什么是字节码，我们再来对比下高级代码、字节码和机器码，你可以参考下图：
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906325584534.jpg)
<center>字节码和机器码占用空间对比</center>
从图中可以看出，机器码所占用的空间远远超过了字节码，所以使用字节码可以减少系统的内存使用。
***
<font color=red>3. 执行代码</font>
**生成字节码之后，接下来就要进入执行阶段了。**
通常，如果有一段第一次执行的字节码，解释器 Ignition 会逐条解释执行。在执行字节码的过程中，**如果发现有热点代码（HotSpot），比如一段代码被重复执行多次，这种就称为热点代码，那么后台的编译器 TurboFan 就会把该段热点的字节码编译为高效的机器码，**然后当再次执行这段被优化的代码时，只需要执行编译后的机器码就可以了，这样就大大提升了代码的执行效率。

V8 的解释器和编译器的取名也很有意思。解释器 Ignition 是点火器的意思，编译器 TurboFan 是涡轮增压的意思，寓意**着代码启动时通过点火器慢慢发动，一旦启动，涡轮增压介入，其执行效率随着执行时间越来越高效率，因为热点代码都被编译器 TurboFan 转换了机器码，直接执行机器码就省去了字节码“翻译”为机器码的过程。**

其实字节码配合解释器和编译器是最近一段时间很火的技术，比如 Java 和 Python 的虚拟机也都是基于这种技术实现的，我们把这种技术称为即时编译（JIT）。具体到 V8，就是指解释器 Ignition 在解释执行字节码的同时，收集代码信息，当它发现某一部分代码变热了之后，**TurboFan 编译器便闪亮登场，把热点的字节码转换为机器码，并把转换后的机器码保存起来，**以备下次使用。

对于 JavaScript 工作引擎，除了 V8 使用了“字节码 +JIT”技术之外，苹果的 SquirrelFish Extreme 和 Mozilla 的 SpiderMonkey 也都使用了该技术。

**JIT 的工作过程：**
![](https://hzy-1301560453.cos.ap-shanghai.myqcloud.com/2020/05/28/15906329298792.jpg)
<center>即时编译（JIT）技术</center>

## JavaScript 的性能优化
我们作为程序员只需要对以下几项进行优化即可。
1. 提升单次脚本的执行速度，避免 JavaScript 的长任务霸占主线程，这样可以使得页面快速响应交互；
2. 避免大的内联脚本，因为在解析 HTML 的过程中，解析和编译也会占用主线程；
3. 减少 JavaScript 文件的容量，因为更小的文件会提升下载速度，并且占用更低的内存。

<font color=red>总结</font>
- 首先我们介绍了编译器和解释器的区别。
- 紧接着又详细分析了 V8 是如何执行一段 JavaScript 代码的：V8 依据 JavaScript 代码生成 AST 和执行上下文，再基于 AST 生成字节码，然后通过解释器执行字节码，通过编译器来优化编译字节码。
- 基于字节码和编译器，我们又介绍了 JIT 技术。
- 最后我们延伸说明了下优化 JavaScript 性能的一些策略。