## TCP协议:怎样完整的送达界面给浏览器

衡量Web界面性能的指标“FP（First Paint）”，指的是从界面加载到首次开始绘制的时长。影响这一指标的因素为网络加载速度。

### 数据包传送

相信大家或多或少的学习过计算机网络。

1. **IP：把数据包送达给目的主机**。计算机的地址称为IP地址，我们访问任何网站实际上都是一台计算机在访问另一台计算机。

如果A想传一个数据包给B，那么在传输之前，数据包会附加B和A的IP地址，有了数据包携带的这些信息，B就可以回复信息给A。并且这些附加的信息会被装在IP头的数据结构里。

IP 头是 IP 数据包开头的信息，包含 IP 版本、源 IP 地址、目标 IP 地址、生存时间等信息。
[IP头](https://www.cnblogs.com/jacklikedogs/articles/3848263.html)

我们先把网络简单分成三层结构：

![](https://cdn.jsdelivr.net/gh/hzy1257664828/Images/img/172192e4c7bcc27c.png)
<center>简化的 IP 网络三层传输模型</center>

下面的我们来介绍下具体步骤：

- 上层将含有“极客时间”的数据包交给网络层；
- 网络层再将 IP 头附加到数据包上，组成新的 IP 数据包，并交给底层；
- 底层通过物理网络将数据包传输给主机 B；
- 数据包被传输到主机 B 的网络层，在这里主机 B 拆开数据包的 IP 头信息，并将拆开来的数据部分交给上层；
- 最终，含有“极客时间”信息的数据包就到达了主机 B 的上层了。

2. **UDP：将数据包传送到应用程序**。用户数据包协议（User Datagram Protocol）”，简称UDP。

UDP和IP的区别就是，UDP都会有个端口号。每个访问了网络的程序都被绑定了一个端口号。UDP通过端口号就可以将数据包准确的送达到指定的应用程序。所以，我们可以理解为IP将数据包送给指定电脑，UDP通过端口号将数据包发给指定的程序。UDP头，端口号在UDP头内部，然后UDP将原始数据+UDP头合并 = 新的UDP数据包。

为了支持UDP，我们在网络层和上层之间增加了一个传输层。

![](https://cdn.jsdelivr.net/gh/hzy1257664828/Images/img/1721934c7b1477e7.png)
<center>简化的 UDP 网络四层传输模型</center>

下面的我们来介绍下具体步骤：
- 上层将含有“极客时间”的数据包交给传输层；
- 传输层会在数据包前面附加上UDP 头，组成新的 UDP 数据包，再将新的 UDP 数据包交给网络层；
- 网络层再将 IP 头附加到数据包上，组成新的 IP 数据包，并交给底层；
- 数据包被传输到主机 B 的网络层，在这里主机 B 拆开 IP 头信息，并将拆开来的数据部分交给传输层；
- 在传输层，数据包中的 UDP 头会被拆开，并根据 UDP 中所提供的端口号，把数据部分交给上层的应用程序；
- 最终，含有“极客时间”信息的数据包就旅行到了主机 B 上层应用程序这里。

**UDP缺点：UDP 不能保证数据可靠性，但是传输速度却非常快**

3. **TCP：可靠传输**

前面我们了解到了UDP可以高速传输，但是不能保证数据的可靠性。因而我们引入了TCP来帮助UDP传输。

**TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。**

- 对于数据包丢失的情况，TCP 提供重传机制；
- TCP 引入了数据包排序机制，用来保证把乱序的数据包组合成一个完整的文件。
- TCP和UDP头一样，TCP头包含了目标端口和本机端口，还提供了要为数据排序的序列号，接收端接受后根据序号重排。


![](https://cdn.jsdelivr.net/gh/hzy1257664828/Images/img/1721939edf16c18f.png)
<center>简化的 TCP 网络四层传输模型
</center>

通过上图我们可以看到完整的 TCP 连接过程，通过这个过程你可以了解TCP的重传机制和数据包排序。

**如下图：三次握手，四次挥手**

一个完整的 TCP 连接的生命周期包括了“建立连接”“传输数据”和“断开连接”三个阶段。

![](https://cdn.jsdelivr.net/gh/hzy1257664828/Images/img/172193c50a54721c.png)
<center>一个 TCP 连接的生命周期
</center>

- 建立连接阶段。通过三次握手来建立C/S之间连接。
- 传输数据阶段。接收端需要对每个数据包进行确认操作，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据。
- 断开连接阶段。数据传输完毕，四次挥手断开连接。